{% extends 'base.html' %}
{% block title %}{{object.name}}{% endblock %}
{% block js %}
<script type="text/javascript"
src="/site_media/js/MochiKit/MochiKit.js"></script>

<script type="text/javascript"
	src="/site_media/js/push.js"></script>
{% endblock %}
{% block content %}

<h1>Push: <a
	     href="{{object.deployment.application.category.get_absolute_url}}">{{object.deployment.application.category.name}}</a> 
: 
<a
   href="{{object.deployment.application.get_absolute_url}}">{{object.deployment.application.name}}</a>
   : 
<a href="{{object.deployment.get_absolute_url}}">{{object.deployment.name}}</a></h1>

{% if push.comment %}
<p>{{object.comment}}</p>
{% endif %}

<p>Started at <b>{{object.start_time}}</b>
  by <b>{{object.user.first_name}} {{object.user.last_name}}</b></p>

<div id="push-status" class="{{object.status}}">{{object.status}}</div>

{% if not push.pushstage_set.count %}
<div>
<!-- the push hasn't actually happened yet. we add the interface doing that here -->

{% if step %}
<input type="submit" value="run all stages" id="runall-button"
       onclick="runAllStages();this.disabled=true;return false" />
{% else %}
<!-- the presence of this input tells the js to run the steps
     as soon as the page loads:  -->
<input type="hidden" value="autorun" id="autorun" name="autorun" />
{% endif %}

{% if rollback %}
<input type="hidden" value="{{rollback}}"
       id="rollback" name="rollback" />
{% endif %}

<h2>stages</h2>

<table style="width: 100%">
{% for stage in object.deployment.stage_set.all %}
<tr class="unknown stage-row" id="stage-{{stage.id}}">
<th>{{stage.name}}</th>
<td><input py:if="step" type="submit" value="execute" id="execute-{{stage.id}}"
onclick="runStage({{stage.id}}); this.disabled=true;return false" />
<input py:if="not step" type="hidden" value="execute" 
id="execute-{{stage.id}}" />
</td>
</tr>
{% endfor %}
</table>
</div>

<div>

{% if push.rollback_url %}
{% ifequal push.status 'ok' %}
<form action="{{object.deployment.get_absolute_url}}rollback/" method="post">
<fieldset><legend>Rollback to this Push</legend>
<input type="hidden" name="push_id" value="{{object.id}}" />
comment <input type="text" name="comment" /> (<input type="checkbox"
						     name="step" />
  step) <input type="submit" value="ROLLBACK" />
</fieldset>
</form>
{% endifequal %}
{% endif %}

{% if push.pushstage_set.count %}
<h2>stages</h2>
<table style="width: 100%">
{% for pushstage in push.pushstage_set.all %}
<tr class="{{pushstage.status}} pushstage-row" id="pushstage-{{pushstage.id}}">
<th>{{pushstage.stage.name}}</th>
<td>{{pushstage.end_time}}</td>
</tr>

{% for log in pushstage.log_set.all %}
<tr>
  {% if log.command %}
  <td colspan="2" class="command"><h3>Code</h3><pre>{{log.command}}</pre></td>
  {% endif %}
  {% if log.stdout %}
  <td colspan="2" class="stdout"><h3>STDOUT</h3><pre>{{log.stdout}}</pre></td>
  {% endif %}
  {% if log.stderr %}
  <td colspan="2" class="stderr"><h3>STDERR</h3><pre>{{log.stderr}}</pre></td>
  {% endif %}
{% endfor %}

{% endfor %}
</table>

<form action="delete/" method="POST">
<fieldset><legend>delete</legend>
Delete this push <input type="submit" value="DELETE" />
</fieldset>
</form>

</div>
{% endif %}
{% endif %}
{% endblock %}
